import type { ComponentType, PropsWithChildren } from "react";
import {
  createBrowserRouter,
  createStaticHandler,
  createStaticRouter,
  type RouteObject,
  RouterProvider,
  StaticRouterProvider,
} from "react-router";

import { baseurl } from "./config";

export default async (
  App: ComponentType<PropsWithChildren>,
  routes: Array<RouteObject>,
  ssrProps?: { url?: URL },
) => {
  const routeStack = [
    {
      path: "/",
      Component: App,
      children: routes,
    },
  ];

  if (ssrProps?.url) {
    const handler = createStaticHandler(routeStack, { basename: baseurl });

    const result = await handler.query(new Request(ssrProps.url.href));

    if (result instanceof Response) {
      // handled by SSR server
      throw result;
    }

    const router = createStaticRouter(routeStack, result);

    return <StaticRouterProvider router={router} context={result} />;
  }

  const router = createBrowserRouter(routeStack, { basename: baseurl });
  return <RouterProvider router={router} />;
};
