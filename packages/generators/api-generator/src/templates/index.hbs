import { join } from "node:path";

import { routerRoutesFactory } from "@kosmojs/api";

import { baseurl, apiurl } from "{{importPathmap.config}}";
import coreMiddleware from "{{importPathmap.coreMiddleware}}";

{{#each routes}}
import {{importName}} from "{{importPathmap.api}}";
import { validationSchemas as {{importName}}_schemas } from "{{importPathmap.schemas}}";
{{/each}}

{{#each useWrappers}}
import {{importName}} from "{{importPath}}";
{{/each}}

export type RouteName ={{#unless routes.length}} never{{/unless}}
{{#each routes}}
| "{{name}}"
{{/each}};

export const routeStackBuilder = () => {
  return routerRoutesFactory(
    [
      {{#each routes}}
      {
        name: "{{name}}",
        {{#if fullpath}}
        path: "{{fullpath}}",
        {{else}}
        path: join(baseurl, apiurl, "{{path}}"),
        {{/if}}
        file: "{{file}}",
        useWrappers: [{{#each useWrappers}}{{importName}}, {{/each}}],
        definitionItems: {{importName}},
        params: [ {{#each params.schema}}[ "{{name}}", {{isRest}} ], {{/each}}],
        numericParams: [ {{#each numericParams}}"{{.}}", {{/each}}],
        validationSchemas: {{importName}}_schemas,
        {{#if meta}}meta: {{meta}},
        {{/if}}
      },
      {{/each}}
    ] as const,
    {
      coreMiddleware,
    }
  );
}
