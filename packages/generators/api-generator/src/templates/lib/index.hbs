import { join } from "node:path";

import {
  type App,
  type AppOptions,
  type Router,
  type RouterOptions,
  createApp,
  createRouter,
  createRouterRoutes,
} from "@kosmojs/api";

import { baseurl, apiurl } from "{{ createImport "config" }}";
import coreMiddleware from "{{ createImport "api" "use" }}";

{{#each routes}}
import {{id}} from "{{ createImport "api" file }}";
import { validationSchemas as {{id}}_schemas } from "{{ createImport "libApi" name "schemas" }}";
{{/each}}

{{#each useWrappers}}
import {{id}} from "{{ createImport "api" file }}";
{{/each}}

export type RouteName ={{#unless routes.length}} never{{/unless}}
{{#each routes}}
| "{{name}}"
{{/each}};

export const createRoutes = () => {
  return createRouterRoutes(
    [
      {{#each routes}}
      {
        name: "{{name}}",
        {{#if fullpath}}
        path: "{{fullpath}}",
        {{else}}
        path: join(baseurl, apiurl, "{{path}}"),
        {{/if}}
        file: "{{file}}",
        useWrappers: [{{#each useWrappers}}...{{id}}, {{/each}}],
        definitionItems: {{id}},
        params: [ {{#each params.schema}}[ "{{name}}", {{isRest}} ], {{/each}}],
        numericParams: [ {{#each numericParams}}"{{.}}", {{/each}}],
        validationSchemas: {{id}}_schemas,
        {{#if meta}}meta: {{meta}},
        {{/if}}
      },
      {{/each}}
    ] as const,
    {
      coreMiddleware,
    }
  );
}

export { createApp, createRouter };

export const appFactory: (
  factory: (app: App, options: AppOptions | undefined) => App | Promise<App>,
) => (options?: AppOptions) => App | Promise<App> = (factory) => {
  return (options) => {
    const app = options ? createApp(options) : createApp();
    return factory(app, options);
  };
};

export const routerFactory: (
  factory: (
    router: Router,
    options: RouterOptions | undefined,
  ) => Router | Promise<Router>,
) => (options?: RouterOptions) => Router | Promise<Router> = (factory) => {
  return (options) => {
    const router = options ? createRouter(options) : createRouter();
    return factory(router, options);
  };
};
