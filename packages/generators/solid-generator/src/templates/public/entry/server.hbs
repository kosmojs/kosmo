import { renderToString, generateHydrationScript } from "solid-js/web";

import { routeStackBuilder } from "{{importPathmap.solid}}/server";
import App from "../App";
import createRouter from "../router";

const routes = routeStackBuilder({ withPreload: false });

export default {
  async factory(url) {
    const router = createRouter(App, routes, { url });
    const hydrationScript = generateHydrationScript();
    return {
      async renderToString({ criticalCss }) {
        const head = criticalCss.reduce(
          (head, { text }) => `${head}\n<style>${text}</style>`,
          hydrationScript,
        );

        const html = renderToString(() => router);

        return { head, html };
      },
    };
  },
} satisfies import("@kosmojs/dev").SSRSetup;
