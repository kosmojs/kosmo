import { A, type AnchorProps, useLocation } from "@solidjs/router";
import { type JSXElement, splitProps } from "solid-js";
import { stringify } from "@kosmojs/fetch";

import { unwrap } from "{{ createImport "lib" "unwrap" }}";
import { type LinkProps, pageMap } from "{{ createImport "lib" "router" }}";
import { baseurl } from "{{ createImport "config" }}";

export default function Link(
  props: Omit<AnchorProps, "href"> & {
    to?: LinkProps;
    query?: Record<string | number, unknown>;
    children: JSXElement;
  },
) {
  const [knownProps, restProps] = splitProps(props, [
    "to",
    "query",
    "children",
  ]);

  const location = useLocation();

  const href = () => {
    if (knownProps.to) {
      const [key, ...params] = knownProps.to;
      return pageMap[key]?.base(params as never, knownProps.query);
    }
    const path = location.pathname.replace(
      new RegExp(`^${baseurl.replace(/\/+$/, "")}/`),
      "/",
    );
    return knownProps.query
      ? [path, stringify(unwrap(knownProps.query))].join("?")
      : path;
  };

  return <A {...{ ...restProps, href: href() }}>{knownProps.children}</A>;
}
