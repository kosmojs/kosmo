import Type from "typebox";
import { Compile } from "typebox/compile";
import Value from "typebox/value";

import type { ValidationErrorScope, ValidationSchema } from "@kosmojs/api";
import { ValidationError } from "@kosmojs/api/errors";

import errorHandlerFactory from "./error-handler";

{{#if importCustomTypes}}
import customTypes from "{{importCustomTypes}}";
{{else}}
const customTypes = {} as const;
{{/if}}

const {
  formatValidationErrors,
  formatValidationErrorMessage,
  getErrorSummary,
} = errorHandlerFactory({{validationMessages}});

export const validationSchemaFactory = (
  schemaText: string,
  { scope }: {
    scope: ValidationErrorScope;
  },
): ValidationSchema => {
  const schema = Type.Script(schemaText);
  const compiledSchema = Compile(customTypes, schema);
  const getSchemaErrors = (data: unknown) => Value.Errors(schema, data);
  return {
    check(data) {
      return compiledSchema.Check(data);
    },
    errors(data) {
      return formatValidationErrors(getSchemaErrors(data));
    },
    errorMessage(data) {
      return formatValidationErrorMessage(getSchemaErrors(data));
    },
    errorSummary(data) {
      return getErrorSummary(getSchemaErrors(data));
    },
    validate(data) {
      if (!this.check(data)) {
        throw new ValidationError([scope, {
          errors: this.errors(data),
          errorMessage: this.errorMessage(data),
          errorSummary: this.errorSummary(data),
        }]);
      }
    },
  };
};
